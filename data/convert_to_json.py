import os
import glob
import gzip
import json
import xml.etree.ElementTree as ET

# ğŸ“‚ è·¯å¾„é…ç½®
# RAW_DIR: å­˜æ”¾ä»å¤©å‡¤ä¸‹è½½çš„ .mjlog æ–‡ä»¶çš„ç›®å½•
RAW_DIR = "./data/raw_mjlog"
# JSON_DIR: è½¬æ¢åçš„ .json æ–‡ä»¶å­˜æ”¾ç›®å½•
JSON_DIR = "./data/json_logs"

def setup_dir():
    """å¦‚æœè¾“å‡ºç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª"""
    if not os.path.exists(JSON_DIR):
        os.makedirs(JSON_DIR)

def tenhou_tile_to_mjai(tile_id):
    """
    ğŸ€„ ç‰Œä»£ç è½¬æ¢å‡½æ•°
    
    å¤©å‡¤ä½¿ç”¨ 0-135 çš„æ•´æ•°æ¥è¡¨ç¤º 136 å¼ éº»å°†ç‰Œã€‚
    è§„åˆ™ï¼š
    - 0-35:   ä¸‡å­ (Man) -> 1m ~ 9m (æ¯ç§4å¼ )
    - 36-71:  ç­’å­ (Pin) -> 1p ~ 9p
    - 72-107: æ¡å­ (Sou) -> 1s ~ 9s
    - 108-135: å­—ç‰Œ (Zi) -> ä¸œå—è¥¿åŒ—ç™½å‘ä¸­ (1z-7z)
    
    ä¸¾ä¾‹: tile_id=0 æ˜¯ 1ä¸‡(1m), tile_id=4 æ˜¯ 2ä¸‡(2m)
    æ³¨æ„ï¼šè¿™é‡Œæš‚æœªå¤„ç†"èµ¤å®ç‰Œ"(Red Dora, é€šå¸¸æ˜¯ id ä¸º 16, 52, 88 çš„ç‰Œ)ï¼Œ
    å¦‚æœéœ€è¦åŒºåˆ†èµ¤ç‰Œï¼Œéœ€è¦é¢å¤–é€»è¾‘ã€‚
    """
    tm = tile_id // 4  # é™¤ä»¥4ï¼Œç®—å‡ºå®ƒæ˜¯å“ªä¸€ç§ç‰Œ(0-33)
    
    if tm < 9:
        return f"{tm + 1}m"  # ä¸‡å­
    elif tm < 18:
        return f"{tm - 9 + 1}p" # ç­’å­
    elif tm < 27:
        return f"{tm - 18 + 1}s" # æ¡å­
    else:
        return f"{tm - 27 + 1}z" # å­—ç‰Œ

def parse_xml_to_json(file_path):
    """è§£æå¤©å‡¤ XML æ ¼å¼çš„éº»å°†ç‰Œè°±æ–‡ä»¶ï¼Œè½¬æ¢ä¸º JSON æ ¼å¼
    
    Args:
        file_path: å¾…è§£æçš„ .mjlog æ–‡ä»¶è·¯å¾„
    
    Returns:
        åŒ…å«æ¸¸æˆäº‹ä»¶åˆ—è¡¨çš„ JSON æ•°æ®ï¼Œè§£æå¤±è´¥è¿”å› None
    """
    try:
        # --- é˜¶æ®µ1: è¯»å–æ–‡ä»¶å†…å®¹ ---
        content = None
        try:
            # ä»¥äºŒè¿›åˆ¶æ¨¡å¼è¯»å–ï¼Œå› ä¸ºæ–‡ä»¶å¯èƒ½æ˜¯ gzip å‹ç¼©æ ¼å¼
            # å¤©å‡¤æœåŠ¡å™¨ä¼ è¾“æ—¶ä¼šå‹ç¼©æ–‡ä»¶ä»¥å‡å°ä½“ç§¯
            with open(file_path, 'rb') as f:
                raw_data = f.read()
                
                # æ£€æŸ¥æ–‡ä»¶å¤´é­”æ•° (Magic Number) æ¥åˆ¤æ–­æ–‡ä»¶ç±»å‹
                # gzip æ ¼å¼çš„æ ‡å‡†é­”æ•°ä¸º 0x1f 0x8b
                if raw_data.startswith(b'\x1f\x8b'):
                    # å¦‚æœæ˜¯å‹ç¼©æ–‡ä»¶ï¼Œå…ˆè§£å‹å†è§£ç ä¸º UTF-8 æ–‡æœ¬
                    content = gzip.decompress(raw_data).decode('utf-8')
                else:
                    # å¦‚æœä¸æ˜¯å‹ç¼©æ–‡ä»¶ï¼Œç›´æ¥å°†å­—èŠ‚æ•°æ®è§£ç ä¸º UTF-8 æ–‡æœ¬
                    content = raw_data.decode('utf-8')
        except Exception as e:
            # æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯å¹¶è¿”å› None
            print(f"è¯»å–æ–‡ä»¶å¤±è´¥: {file_path}, {e}")
            return None

        # --- é˜¶æ®µ2: è§£æ XML ç»“æ„ ---
        try:
            # å°† XML å­—ç¬¦ä¸²è§£æä¸º ElementTree æ ‘ç»“æ„
            # ä¾¿äºåç»­éå†å’Œæå–æ•°æ®
            root = ET.fromstring(content)
        except ET.ParseError:
            # XML æ ¼å¼é”™è¯¯ï¼Œè¿”å› None
            return None

        # åˆå§‹åŒ–æ¸¸æˆæ—¥å¿—åˆ—è¡¨ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰è§£æå‡ºçš„æ¸¸æˆäº‹ä»¶
        game_log = []
        
        # --- é˜¶æ®µ3: éå† XML èŠ‚ç‚¹ï¼Œè§£æäº‹ä»¶æµ ---
        # å¤©å‡¤çš„ XML é‡‡ç”¨æ‰å¹³åŒ–ç»“æ„ï¼Œæ¯ä¸ªå­èŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªæ¸¸æˆåŠ¨ä½œ
        # ä¾‹å¦‚: <INIT>, <T12>, <D30>, <N>, <REACH> ç­‰
        for child in root:
            # æå–èŠ‚ç‚¹çš„æ ‡ç­¾åå’Œå±æ€§
            tag = child.tag      # æ ‡ç­¾å (å¦‚ INIT, T12, D30, N, REACH)
            attrs = child.attrib # å±æ€§å­—å…¸ (å¦‚ seed="...", hai0="...")
            
            # åˆå§‹åŒ–å½“å‰äº‹ä»¶å­—å…¸
            event = {}
            
            # ==========================================
            # äº‹ä»¶ç±»å‹1: ä¸€å±€å¼€å§‹ (INIT)
            # ==========================================
            if tag == 'INIT':
                # seed å±æ€§æ ¼å¼: "å±€æ•°,æœ¬åœº,ä¾›æ‰˜,éª°å­1,éª°å­2,å®ç‰ŒæŒ‡ç¤ºç‰ŒID"
                # ä¾‹å¦‚: "4,0,0,2,4,16" è¡¨ç¤ºå—ä¸€å±€ï¼Œ0æœ¬åœºï¼Œ0ä¾›æ‰˜ï¼Œéª°å­2å’Œ4ï¼Œå®ç‰ŒæŒ‡ç¤ºç‰ŒIDä¸º16
                seed = [int(x) for x in attrs['seed'].split(',')]
                
                # è®¡ç®—åœºé£ (Prevalent Wind)
                # å¤©å‡¤ç”¨æ•°å­—è¡¨ç¤ºå±€æ•°ï¼Œæ¯4å±€æ¢ä¸€æ¬¡åœºé£ï¼š
                # å±€æ•° 0-3: ä¸œåœº (East)
                # å±€æ•° 4-7: å—åœº (South)
                # å±€æ•° 8-11: è¥¿åœº (West)
                # å±€æ•° 12-15: åŒ—åœº (North)
                round_idx = seed[0] // 4
                winds = ['E', 'S', 'W', 'N']  # ä¸œ, å—, è¥¿, åŒ—
                bakaze = winds[round_idx % 4]
                
                # æ„é€ ä¸€å±€å¼€å§‹äº‹ä»¶
                event = {
                    "type": "start_kyoku",      # äº‹ä»¶ç±»å‹
                    "bakaze": bakaze,             # åœºé£ (E/S/W/N)
                    "kyoku": (seed[0] % 4) + 1,   # ç¬¬å‡ å±€ (1-4)
                    "honba": seed[1],             # æœ¬åœºæ•° (è¿åº„æ¬¡æ•°)
                    "kyotaku": seed[2],           # ä¾›æ‰˜/ç«‹ç›´æ£’æ•°é‡
                    "dora_marker": tenhou_tile_to_mjai(seed[5]), # å®ç‰ŒæŒ‡ç¤ºç‰Œ
                    "tehais": []                  # å››ä½ç©å®¶çš„åˆå§‹æ‰‹ç‰Œ
                }
                
                # è§£æå››ä½ç©å®¶çš„åˆå§‹æ‰‹ç‰Œ
                # å±æ€§åæ ¼å¼: hai0, hai1, hai2, hai3 (åˆ†åˆ«å¯¹åº”ä¸œã€å—ã€è¥¿ã€åŒ—å®¶)
                # å€¼æ ¼å¼: "11,22,33,44..." çš„é€—å·åˆ†éš”å­—ç¬¦ä¸²
                for i in range(4):
                    hai_str = attrs.get(f'hai{i}')
                    if hai_str:
                        # å°†ç‰ŒIDå­—ç¬¦ä¸²è½¬æ¢ä¸ºç‰Œçš„ä»£ç åˆ—è¡¨
                        # tenhou_tile_to_mjai å‡½æ•°å°†å¤©å‡¤çš„ç‰ŒIDè½¬æ¢ä¸ºæ ‡å‡†éº»å°†ç‰Œç 
                        tiles = [tenhou_tile_to_mjai(int(t)) for t in hai_str.split(',')]
                        event['tehais'].append(tiles)
                    else:
                        # å¦‚æœè¯¥ä½ç½®æ²¡æœ‰æ‰‹ç‰Œæ•°æ®ï¼ˆå¯èƒ½æ˜¯ä¸‰äººå¯¹å±€æˆ–æ–­çº¿ï¼‰ï¼Œæ·»åŠ ç©ºåˆ—è¡¨
                        event['tehais'].append([])
                
            # ==========================================
            # äº‹ä»¶ç±»å‹2: é¸£ç‰Œ (N) - åƒã€ç¢°ã€å¤§æ˜æ 
            # ==========================================
            elif tag == 'N':
                # N æ ‡ç­¾è¡¨ç¤ºç©å®¶è¿›è¡Œå‰¯éœ²ï¼ˆé¸£ç‰Œï¼‰æ“ä½œ
                # å±æ€§è¯´æ˜:
                #   who: è¿›è¡Œé¸£ç‰Œçš„ç©å®¶ID (0-3ï¼Œåˆ†åˆ«ä»£è¡¨ä¸œã€å—ã€è¥¿ã€åŒ—å®¶)
                #   m: ä½æ©ç ï¼Œç¼–ç äº†è¯¦ç»†çš„é¸£ç‰Œä¿¡æ¯
                #      åŒ…å«: åƒäº†å“ªå¼ ç‰Œã€ä»è°é‚£é‡Œåƒçš„ã€åƒçš„æ–¹å¼ï¼ˆå·¦/ä¸­/å³ç¢°ï¼‰ç­‰
                #      ç”±äºä½è¿ç®—é€»è¾‘å¤æ‚ï¼Œè¿™é‡Œæš‚ä¸è¯¦ç»†è§£ç ï¼Œä¿ç•™åŸå§‹å€¼
                event = {
                    "type": "naki",               # äº‹ä»¶ç±»å‹
                    "who": int(attrs.get('who')), # é¸£ç‰Œç©å®¶ID
                    "raw_m": attrs.get('m')       # åŸå§‹ä½æ©ç å€¼
                }
                
            # ==========================================
            # äº‹ä»¶ç±»å‹3: ç«‹ç›´ (REACH)
            # ==========================================
            elif tag == 'REACH':
                # ç«‹ç›´æ“ä½œåˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼Œå¯¹åº”ä¸¤ä¸ªäº‹ä»¶:
                # step="1": ç©å®¶å®£è¨€ç«‹ç›´ï¼ˆå–Š"ç«‹ç›´"ï¼‰ï¼Œç´§æ¥ç€ä¼šåˆ‡å‡ºä¸€å¼ ç‰Œ
                # step="2": ç©å®¶æ”¾ä¸Š1000ç‚¹ç«‹ç›´æ£’ï¼Œç«‹ç›´æ­£å¼æˆç«‹
                event = {
                    "type": "reach",               # äº‹ä»¶ç±»å‹
                    "who": int(attrs.get('who')),  # ç«‹ç›´ç©å®¶ID
                    "step": attrs.get('step')      # ç«‹ç›´æ­¥éª¤ ("1" æˆ– "2")
                }
                
            # ==========================================
            # äº‹ä»¶ç±»å‹4: å’Œç‰Œ/æ¸¸æˆç»“æŸ (AGARI)
            # ==========================================
            elif tag == 'AGARI':
                # AGARI è¡¨ç¤ºç©å®¶å’Œç‰Œï¼ŒåŒ…å«è¯¦ç»†å’Œç‰Œä¿¡æ¯:
                #   who: å’Œç‰Œç©å®¶ID
                #   fromWho: æ”¾é“³ç©å®¶ID (-1 è¡¨ç¤ºè‡ªæ‘¸)
                #   ten: å’Œç‰Œç‚¹æ•°
                #   yaku: å½¹ç§åˆ—è¡¨
                #   doraHai: å®ç‰Œåˆ—è¡¨
                #   machi: å¾…ç‰Œå½¢çŠ¶ï¼ˆè¾¹å¼ ã€åµŒå¼ ã€åŒç¢°ç­‰ï¼‰
                # å½“å‰ç‰ˆæœ¬åªæ ‡è®°ä¸ºå’Œç‰Œäº‹ä»¶ï¼Œæš‚ä¸è§£æè¯¦ç»†ä¿¡æ¯
                event = {"type": "hora"} 

            # ==========================================
            # äº‹ä»¶ç±»å‹5: æµå±€ (RYUUKYOKU)
            # ==========================================
            elif tag == 'RYUUKYOKU':
                # RYUUKYOKU è¡¨ç¤ºæµå±€ï¼ˆæ— äººå’Œç‰Œï¼‰
                # å¯èƒ½åŒ…å«åŸå› ï¼Œå¦‚: "nm" (è’ç‰Œæµå±€), "k" (ä¹ç§ä¹ç‰Œ), "r" (å››é£è¿æ‰“) ç­‰
                event = {"type": "ryukyoku"}
                
            # ==========================================
            # äº‹ä»¶ç±»å‹6: æ‘¸ç‰Œ/åˆ‡ç‰Œ (T/D/U/E/V/F/W/G)
            # ==========================================
            # å¤©å‡¤ä½¿ç”¨å•å­—æ¯ç¼–ç æ¥è¡¨ç¤ºç©å®¶çš„æ‘¸ç‰Œå’Œåˆ‡ç‰ŒåŠ¨ä½œ:
            #   ç©å®¶0 (ä¸œå®¶): T(æ‘¸ç‰Œ), D(åˆ‡ç‰Œ)
            #   ç©å®¶1 (å—å®¶): U(æ‘¸ç‰Œ), E(åˆ‡ç‰Œ)
            #   ç©å®¶2 (è¥¿å®¶): V(æ‘¸ç‰Œ), F(åˆ‡ç‰Œ)
            #   ç©å®¶3 (åŒ—å®¶): W(æ‘¸ç‰Œ), G(åˆ‡ç‰Œ)
            # å­—æ¯åçš„æ•°å­—è¡¨ç¤ºç‰Œçš„ID (å¤©å‡¤å†…éƒ¨ç¼–ç )
            # ä¾‹å¦‚: T12 è¡¨ç¤ºä¸œå®¶æ‘¸åˆ°IDä¸º12çš„ç‰Œ
            elif len(tag) > 1 and tag[0] in ['T', 'D', 'U', 'E', 'V', 'F', 'W', 'G'] and tag[1:].isdigit():
                # åˆ¤æ–­åŠ¨ä½œç±»å‹: é¦–å­—æ¯åœ¨ T/U/V/W ä¸­è¡¨ç¤ºæ‘¸ç‰Œï¼Œå¦åˆ™ä¸ºåˆ‡ç‰Œ
                action_type = "tsumo" if tag[0] in ['T','U','V','W'] else "dahai"
                
                # å»ºç«‹å­—æ¯åˆ°ç©å®¶IDçš„æ˜ å°„å…³ç³»
                player_map = {
                    'T':0, 'D':0,  # ç©å®¶0 (ä¸œå®¶)
                    'U':1, 'E':1,  # ç©å®¶1 (å—å®¶)
                    'V':2, 'F':2,  # ç©å®¶2 (è¥¿å®¶)
                    'W':3, 'G':3   # ç©å®¶3 (åŒ—å®¶)
                }
                # æå–ç©å®¶IDå’Œç‰ŒID
                player_id = player_map[tag[0]]
                tile_id = int(tag[1:])
                
                # æ„é€ æ‘¸ç‰Œæˆ–åˆ‡ç‰Œäº‹ä»¶
                event = {
                    "type": action_type,                 # "tsumo" æˆ– "dahai"
                    "actor": player_id,                  # æ‰§è¡ŒåŠ¨ä½œçš„ç©å®¶ID
                    "pai": tenhou_tile_to_mjai(tile_id)  # è½¬æ¢åçš„ç‰Œç 
                }
            
            # å¦‚æœæˆåŠŸè§£æå‡ºäº‹ä»¶ï¼Œå°†å…¶æ·»åŠ åˆ°æ¸¸æˆæ—¥å¿—åˆ—è¡¨ä¸­
            if event:
                game_log.append(event)
                
        # è¿”å›å®Œæ•´çš„æ¸¸æˆäº‹ä»¶æ—¥å¿—
        return game_log

    except Exception as e:
        # æ•è·è§£æè¿‡ç¨‹ä¸­çš„ä»»ä½•å¼‚å¸¸ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯å¹¶è¿”å› None
        print(f"è§£æå¼‚å¸¸ {file_path}: {e}")
        return None

def main():
    # è®¾ç½®å¿…è¦çš„ç›®å½•ç»“æ„
    setup_dir()
    
    # æŸ¥æ‰¾æ‰€æœ‰å¾…è½¬æ¢çš„ .mjlog æ–‡ä»¶
    # glob.glob è¿”å›åŒ¹é…æŒ‡å®šè·¯å¾„æ¨¡å¼çš„æ–‡ä»¶è·¯å¾„åˆ—è¡¨
    files = glob.glob(os.path.join(RAW_DIR, "*.mjlog"))
    
    # è¾“å‡ºå¾…è½¬æ¢æ–‡ä»¶æ€»æ•°
    print(f"å¼€å§‹è½¬æ¢ {len(files)} ä¸ªæ–‡ä»¶...")
    
    # åˆå§‹åŒ–è®¡æ•°å™¨ï¼Œè®°å½•å·²æˆåŠŸè½¬æ¢çš„æ–‡ä»¶æ•°é‡
    count = 0
    
    # éå†æ‰€æœ‰å¾…è½¬æ¢çš„æ–‡ä»¶
    for fpath in files:
        # è°ƒç”¨è§£æå‡½æ•°ï¼Œå°† XML æ ¼å¼çš„ mjlog æ–‡ä»¶è½¬æ¢ä¸º JSON æ•°æ®ç»“æ„
        json_data = parse_xml_to_json(fpath)
        
        # åªæœ‰å½“è§£ææˆåŠŸæ—¶æ‰è¿›è¡Œä¿å­˜æ“ä½œ
        if json_data:
            # æ„é€ è¾“å‡ºæ–‡ä»¶åï¼šå°†åŸæ–‡ä»¶çš„ .mjlog æ‰©å±•åæ›¿æ¢ä¸º .json
            fname = os.path.basename(fpath).replace('.mjlog', '.json')
            # æ„é€ å®Œæ•´çš„è¾“å‡ºæ–‡ä»¶è·¯å¾„
            save_path = os.path.join(JSON_DIR, fname)
            
            # å°† JSON æ•°æ®å†™å…¥æ–‡ä»¶
            # encoding='utf-8': æŒ‡å®šæ–‡ä»¶ç¼–ç ä¸º UTF-8ï¼Œç¡®ä¿ä¸­æ–‡å­—ç¬¦æ­£ç¡®å­˜å‚¨
            # separators=(',', ':'): å»é™¤ JSON å­—ç¬¦ä¸²ä¸­çš„ç©ºæ ¼å’Œæ¢è¡Œï¼Œå‡å°æ–‡ä»¶ä½“ç§¯
            with open(save_path, 'w', encoding='utf-8') as f:
                json.dump(json_data, f, separators=(',', ':')) 
            
            # æˆåŠŸè½¬æ¢ä¸€ä¸ªæ–‡ä»¶åè®¡æ•°å™¨åŠ  1
            count += 1
            
            # æ¯è½¬æ¢ 10 ä¸ªæ–‡ä»¶è¾“å‡ºä¸€æ¬¡è¿›åº¦ï¼Œé¿å…é¢‘ç¹è¾“å‡ºå½±å“æ€§èƒ½
            if count % 10 == 0:
                print(f"å·²è½¬æ¢ {count} ä¸ªæ–‡ä»¶")

    # è¾“å‡ºè½¬æ¢å®Œæˆä¿¡æ¯åŠæ–‡ä»¶ä¿å­˜ä½ç½®
    print(f"è½¬æ¢å®Œæˆï¼JSONæ–‡ä»¶ä¿å­˜åœ¨: {JSON_DIR}")

if __name__ == "__main__":
    main()